-- SCRIPT DE CONFIGURAÇÃO DO BANCO DE DADOS EPIVIU
-- Execute este script no SQL Editor do seu projeto Supabase

-- 1. Criar tabela de Equipe (Staff)
CREATE TABLE IF NOT EXISTS public.staff (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    shift TEXT NOT NULL CHECK (shift IN ('morning', 'afternoon', 'oncall')),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. Criar tabela de Setores (Sectors)
CREATE TABLE IF NOT EXISTS public.sectors (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    staff_id BIGINT REFERENCES public.staff(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. Criar tabela de Visitas Não Realizadas (Missed Visits)
CREATE TABLE IF NOT EXISTS public.missed_visits (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sector_id BIGINT REFERENCES public.sectors(id) ON DELETE CASCADE,
    visit_date DATE NOT NULL DEFAULT CURRENT_DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(sector_id, visit_date)
);

-- 4. Habilitar Row Level Security (RLS)
ALTER TABLE public.staff ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sectors ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.missed_visits ENABLE ROW LEVEL SECURITY;

-- 5. Criar Políticas de Acesso (RLS Policies)
-- Permitir que qualquer usuário autenticado leia e modifique os dados

-- Políticas para STAFF
DO $$ BEGIN
    CREATE POLICY "Permitir leitura para usuários autenticados" ON public.staff FOR SELECT TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir inserção para usuários autenticados" ON public.staff FOR INSERT TO authenticated WITH CHECK (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir atualização para usuários autenticados" ON public.staff FOR UPDATE TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir exclusão para usuários autenticados" ON public.staff FOR DELETE TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- Políticas para SECTORS
DO $$ BEGIN
    CREATE POLICY "Permitir leitura para usuários autenticados" ON public.sectors FOR SELECT TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir inserção para usuários autenticados" ON public.sectors FOR INSERT TO authenticated WITH CHECK (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir atualização para usuários autenticados" ON public.sectors FOR UPDATE TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir exclusão para usuários autenticados" ON public.sectors FOR DELETE TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- Políticas para MISSED_VISITS
DO $$ BEGIN
    CREATE POLICY "Permitir leitura para usuários autenticados" ON public.missed_visits FOR SELECT TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir inserção para usuários autenticados" ON public.missed_visits FOR INSERT TO authenticated WITH CHECK (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir atualização para usuários autenticados" ON public.missed_visits FOR UPDATE TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "Permitir exclusão para usuários autenticados" ON public.missed_visits FOR DELETE TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- 6. Inserir Dados Iniciais (Opcional - Baseado na Planilha)
-- Inserir Equipe
INSERT INTO public.staff (name, shift) VALUES 
('Nayana', 'morning'),
('Cleonice', 'morning'),
('Plantonista Manhã', 'morning'),
('Juliana', 'afternoon'),
('Shirley', 'afternoon'),
('Plantonista Tarde', 'afternoon');

-- Inserir Setores (Vincular aos IDs gerados acima)
-- Nota: Usamos subconsultas para garantir o vínculo correto pelo nome
INSERT INTO public.sectors (name, staff_id) VALUES 
('Sala Verde', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('EP', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('UTI 3', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('UC1', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('Necrotério', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('P3', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('P6', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('P9', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),
('P11(229,230,231,232)', (SELECT id FROM public.staff WHERE name = 'Nayana' AND shift = 'morning')),

('Sala Vermelha', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),
('UTI 1', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),
('UTI 4', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),
('UC2', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),
('P1', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),
('P4', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),
('P7', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),
('P11 (236,237, LEITOS EXTRAS)', (SELECT id FROM public.staff WHERE name = 'Cleonice' AND shift = 'morning')),

('Sala de Trauma', (SELECT id FROM public.staff WHERE name = 'Plantonista Manhã' AND shift = 'morning')),
('UTI 2', (SELECT id FROM public.staff WHERE name = 'Plantonista Manhã' AND shift = 'morning')),
('UTQ', (SELECT id FROM public.staff WHERE name = 'Plantonista Manhã' AND shift = 'morning')),
('Centro Cirúrgico (CC)', (SELECT id FROM public.staff WHERE name = 'Plantonista Manhã' AND shift = 'morning')),
('P2', (SELECT id FROM public.staff WHERE name = 'Plantonista Manhã' AND shift = 'morning')),
('P5', (SELECT id FROM public.staff WHERE name = 'Plantonista Manhã' AND shift = 'morning')),
('P8', (SELECT id FROM public.staff WHERE name = 'Plantonista Manhã' AND shift = 'morning')),

('Sala Verde', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('EP', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('UTI 3', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('UC1', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('Necrotério', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('P3', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('P6', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('P9', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),
('P11 (233,234,235)', (SELECT id FROM public.staff WHERE name = 'Juliana' AND shift = 'afternoon')),

('Sala Vermelha', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),
('UTI 1', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),
('UTI 4', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),
('UC2', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),
('P1', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),
('P4', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),
('P7', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),
('P11  (238,239)', (SELECT id FROM public.staff WHERE name = 'Shirley' AND shift = 'afternoon')),

('Sala de Trauma', (SELECT id FROM public.staff WHERE name = 'Plantonista Tarde' AND shift = 'afternoon')),
('UTI 2', (SELECT id FROM public.staff WHERE name = 'Plantonista Tarde' AND shift = 'afternoon')),
('UTQ', (SELECT id FROM public.staff WHERE name = 'Plantonista Tarde' AND shift = 'afternoon')),
('Centro Cirúrgico (CC)', (SELECT id FROM public.staff WHERE name = 'Plantonista Tarde' AND shift = 'afternoon')),
('P2', (SELECT id FROM public.staff WHERE name = 'Plantonista Tarde' AND shift = 'afternoon')),
('P5', (SELECT id FROM public.staff WHERE name = 'Plantonista Tarde' AND shift = 'afternoon')),
('P8', (SELECT id FROM public.staff WHERE name = 'Plantonista Tarde' AND shift = 'afternoon'));
